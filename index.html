<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>multi_memo</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2c3e50">
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¸</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojZTc0YzNjIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjE1JSIgZmlsbD0iI2U3NGMzYyIvPjxwYXRoIGQ9Ik0xMjggMTI4djI1NmgyNTZWMTI4SDEyOHptMzIgMzJowTkydjE5MmgtMTkyVjE2MHptNDggNDh2OTZsODAtNDgtODAtNDh6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==">

  <style>
    /* --- CSSè¨­å®š --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100vh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      flex-direction: column;
      background-color: #f0f0f0;
      overscroll-behavior-y: none;
    }

    header {
      background-color: #2c3e50;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 100;
    }

    #filename-wrapper {
      flex: 1;
      display: flex;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      min-width: 120px;
    }
    #filename-input {
      width: 100%;
      border: none;
      padding: 10px;
      font-size: 16px;
      outline: none;
      flex: 1;
      min-width: 0;
      border-radius: 0;
    }
    #ext-select {
      background: #eee;
      color: #333;
      border: none;
      border-left: 1px solid #ddd;
      padding: 0 5px;
      font-size: 14px;
      font-weight: bold;
      outline: none;
      border-radius: 0;
      -webkit-appearance: none;
      text-align: center;
    }

    .btn-group { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
    .btn {
      border: none;
      border-radius: 6px;
      height: 40px;
      padding: 0 10px;
      font-weight: bold;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-icon { font-size: 20px; min-width: 40px; padding: 0; }
    
    /* ãƒœã‚¿ãƒ³ã®è‰²è¨­å®š */
    .btn-open { background-color: #7f8c8d; }
    .btn-camera { background-color: #e74c3c; } /* å†™çœŸ */
    .btn-video { background-color: #9b59b6; }  /* å‹•ç”» (ç´«) */
    .btn-mic { background-color: #c0392b; }    /* éŒ²éŸ³ (æ¿ƒã„èµ¤) */
    .btn-media { background-color: #e67e22; }  /* ã‚¢ãƒ«ãƒãƒ æŒ¿å…¥ */
    .btn-save { background-color: #3498db; }
    
    .btn:active { opacity: 0.7; transform: scale(0.96); }

    .hidden-input { display: none; }

    main {
      flex: 1;
      position: relative;
      background: white;
      margin: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #editor {
      flex: 1;
      width: 100%;
      height: 100%;
      padding: 15px;
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      overflow-y: auto;
      color: #333;
      font-family: monospace;
      white-space: pre-wrap; 
      word-wrap: break-word;
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ã‚¿ã‚¤ãƒ« */
    #editor img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; display: block; }
    #editor video { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; display: block; }
    #editor audio { max-width: 100%; margin: 10px 0; display: block; }

    @media (max-width: 450px) {
      header { padding: 8px; gap: 6px; }
      #filename-wrapper { min-width: 100%; order: 1; margin-bottom: 4px; }
      .btn-group { width: 100%; order: 2; display: flex; justify-content: space-between; gap: 4px; }
      .btn { flex: 1; padding: 0; }
    }
  </style>
</head>
<body>

  <header>
    <div id="filename-wrapper">
      <input type="text" id="filename-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
      <select id="ext-select">
        <option value="txt" selected>.txt</option>
        <option value="md">.md</option>
        <option value="html">.html</option>
        <option value="js">.js</option>
        <option value="csv">.csv</option>
        <option value="py">.py</option>
      </select>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-open btn-icon" onclick="document.getElementById('file-opener').click()" title="é–‹ã">ğŸ“‚</button>
      
      <button class="btn btn-camera btn-icon" onclick="document.getElementById('camera-input').click()" title="å†™çœŸæ’®å½±">ğŸ“¸</button>
      <button class="btn btn-video btn-icon" onclick="document.getElementById('video-input').click()" title="å‹•ç”»æ’®å½±">ğŸ¥</button>
      <button class="btn btn-mic btn-icon" onclick="document.getElementById('mic-input').click()" title="éŒ²éŸ³">ğŸ™ï¸</button>
      
      <button class="btn btn-media btn-icon" onclick="document.getElementById('media-inserter').click()" title="ãƒ•ã‚¡ã‚¤ãƒ«æŒ¿å…¥">ğŸ–¼ï¸</button>
      
      <button class="btn btn-save" id="save-btn">ğŸ’¾</button>
    </div>
    
    <input type="file" id="file-opener" class="hidden-input" accept=".html,.htm,.txt,.md,.js,.csv,.py">
    
    <input type="file" id="camera-input" class="hidden-input" accept="image/*" capture="environment">
    <input type="file" id="video-input" class="hidden-input" accept="video/*" capture="environment">
    <input type="file" id="mic-input" class="hidden-input" accept="audio/*" capture>
    
    <input type="file" id="media-inserter" class="hidden-input" accept="image/*,video/*,audio/*">
  </header>

  <main>
    <div id="editor" contenteditable="true"></div>
  </main>

  <script>
    // --- è¦ç´ å–å¾— ---
    const editor = document.getElementById('editor');
    const filenameInput = document.getElementById('filename-input');
    const extSelect = document.getElementById('ext-select');
    let savedRange = null;

    // --- æ—¥æ™‚ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    function getTimestampName() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const nn = String(now.getMinutes()).padStart(2, '0');
      return `memo_${yyyy}${mm}${dd}_${hh}${nn}`;
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«åã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ---
    function autoUpdateFilename() {
       const currentVal = filenameInput.value;
       const pattern = /^memo_\d{8}_\d{4}$/; 
       if (!currentVal || pattern.test(currentVal)) {
         filenameInput.value = getTimestampName();
       }
    }

    autoUpdateFilename();
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") autoUpdateFilename();
    });

    // --- LocalStorageã¸ã®è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ ---
    function autoSave() {
        const data = {
            filename: filenameInput.value,
            ext: extSelect.value,
            content: editor.innerHTML,
            timestamp: Date.now()
        };
        try {
            localStorage.setItem('memo_autosave', JSON.stringify(data));
        } catch(e) {
            console.warn("Storage full or error", e);
        }
    }

    let saveTimer;
    editor.addEventListener('input', () => {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(autoSave, 2000);
    });
    
    filenameInput.addEventListener('input', autoSave);
    extSelect.addEventListener('change', autoSave);

    window.addEventListener('load', () => {
        const saved = localStorage.getItem('memo_autosave');
        if (saved && !editor.innerHTML.trim()) {
            const data = JSON.parse(saved);
            filenameInput.value = data.filename;
            extSelect.value = data.ext;
            editor.innerHTML = data.content;
        }
    });

    // --- ã‚¨ãƒ‡ã‚£ã‚¿é–¢é€£ ---
    editor.addEventListener('blur', () => {
      const sel = window.getSelection();
      if (sel.rangeCount > 0) savedRange = sel.getRangeAt(0);
    });

    function insertNode(node) {
      editor.focus();
      const sel = window.getSelection();
      if (savedRange) { sel.removeAllRanges(); sel.addRange(savedRange); }
      
      let range = sel.rangeCount > 0 ? sel.getRangeAt(0) : document.createRange();
      if (sel.rangeCount === 0) {
          range.selectNodeContents(editor);
          range.collapse(false);
          sel.addRange(range);
      }
      
      range.insertNode(node);
      range.setStartAfter(node);
      range.setEndAfter(node);
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
      document.execCommand('insertHTML', false, '<br><br>');
      autoSave();
    }

    // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆç”»åƒãƒ»å‹•ç”»ãƒ»éŸ³å£°ï¼‰
    function handleFile(file) {
      if(!file) return;
      
      const type = file.type;
      const reader = new FileReader();

      reader.onload = (e) => {
          let el;
          if (type.startsWith('image/')) {
              el = document.createElement('img');
              el.src = e.target.result;
          } else if (type.startsWith('video/')) {
              el = document.createElement('video');
              el.src = e.target.result;
              el.controls = true;
          } else if (type.startsWith('audio/')) {
              el = document.createElement('audio');
              el.src = e.target.result;
              el.controls = true;
          }
          if(el) insertNode(el);
      };
      reader.readAsDataURL(file);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    const inputs = ['camera-input', 'video-input', 'mic-input', 'media-inserter'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('change', function(e){
            handleFile(e.target.files[0]);
            this.value = '';
        });
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãå‡¦ç†
    document.getElementById('file-opener').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        let content = event.target.result;
        const name = file.name;
        const lastDot = name.lastIndexOf('.');
        if (lastDot !== -1) {
          filenameInput.value = name.substring(0, lastDot);
          const ext = name.substring(lastDot + 1).toLowerCase();
          const opts = Array.from(extSelect.options).map(o => o.value);
          extSelect.value = opts.includes(ext) ? ext : 'txt';

          if(ext === 'html' || ext === 'htm') {
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const savedContent = doc.querySelector('#saved-content');
            editor.innerHTML = savedContent ? savedContent.innerHTML : doc.body.innerHTML;
          } else {
            editor.innerText = content;
          }
          autoSave();
        }
      };
      reader.readAsText(file);
      this.value = '';
    });

    // --- ä¿å­˜å‡¦ç† ---
    document.getElementById('save-btn').addEventListener('click', async () => {
      try {
        autoSave();
        autoUpdateFilename();
        
        const name = filenameInput.value;
        const ext = extSelect.value;
        const fullName = `${name}.${ext}`;
        
        let content = '';
        let mime = 'text/plain';

        if (ext === 'html') {
            mime = 'text/html';
            content = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${name}</title><style>body{font-family:sans-serif;padding:20px;line-height:1.6;max-width:800px;margin:0 auto}img,video{max-width:100%;height:auto}audio{width:100%}</style></head><body><div id="saved-content">${editor.innerHTML}</div></body></html>`;
        } else if (ext === 'md') {
            mime = 'text/markdown';
            content = editor.innerText;
        } else {
            content = editor.innerText;
        }

        const blob = new Blob([content], { type: mime });
        const fileObj = new File([blob], fullName, { type: mime });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [fileObj] })) {
            await navigator.share({
                files: [fileObj],
                title: fullName,
            });
            return;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fullName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);

      } catch (e) {
        if (e.name !== 'AbortError') {
            alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
      }
    });
  </script>
</body>
</html>